aggr-json: |
  // tag::aggr-json[]
  [{"unify": [{"from": "customers",
               "bind": [{"xt/id": {"xt:lvar": "customer-id"}},
                        {"name": {"xt:lvar": "customer-name"}}]},
              {"from": "orders",
               "bind": [{"customer-id": {"xt:lvar": "customer-id"}},
                        {"order-value": {"xt:lvar": "order-value"}}]}]},
   {"aggregate": ["customer-id", "customer-name",
                  {"order-count": {"xt:call": "row-count",
                                   "args": []}},
                  {"total-value": {"xt:call": "sum",
                                   "args": [{"xt:lvar": "order-value"}]}}]}]
  // end::aggr-json[]

from-json: |
  // tag::from-json[]
  //`SELECT username, first_name, last_name FROM users`
  {"from": "users",
   "bind": ["username", "first-name", "last-name"]}
  // `SELECT username AS login, first_name, last_name FROM users`
  {"from": "users",
   "bind": [{"username": {"xt:lvar": "login"}}, "first-name", "last-name"]}
  // `SELECT first_name, last_name FROM users WHERE username = 'james'`
  {"from": "users",
   "bind": [{"username": "james"}, "first-name", "last-name"]}
  // `SELECT first_name, last_name FROM users WHERE username = ?`
  {"from": "users",
   "bind": [{"username": {"xt:param": "$username"}}, "first-name", "last-name"]}
  // end::from-json[]

from-star-json: |
  // tag::from-star-json[]
  // `SELECT * FROM users`
  {"from": "users",
   "projectAllCols": true}
  // `SELECT *, username AS login FROM users`
  {"from": "users",
   "bind": [{"username": {"xt:lvar": "login"}}],
   "projectAllCols": true}
  // end::from-star-json[]

star-invalid-json: |
  // tag::star-invalid-json[]
  {"unify": [{"from": "users",
              "projectAllCols": true},
             {"from": "customers",
              "projectAllCols": true}]}
  // end::star-invalid-json[]

temporal-fitlers-json: |
  // tag::temporal-filters-json[]
  {"from": "users",
   "bind": [{"xt/id" : { "xt:lvar": "user"}}],
   "forValidTime": { "in": [{ "@type": "xt:instant",
                              "@value": "2020-01-01T00:00:00Z"},
                            { "@type": "xt:instant",
                              "@value": "2021-01-01T00:00:00Z"}]},
   "forSystemTime": { "at": { "@type": "xt:instant",
                              "@value": "2023-01-01T00:00:00Z"}}}
  // end::temporal-filters-json[]

joins-json: |
  // tag::joins-json[]
  {"unify": [{"from": "customers",
              "bind": [{"xt/id": {"xt:lvar": "customer-id"}}, "customer-name"]},
             {"leftJoin": { "from": "orders",
                            "bind": [{ "xt/id": { "xt:lvar": "order-id"}}, "customer-id", "order-value"]},
              "bind": ["customer-id", "order-id", "order-value"]}]}
  // end::joins-json[]

limit-json: |
  // tag::limit-json[]
  [{"from": "users",
    "bind": ["username"]},
    {"orderBy": ["username"]},
    {"limit": 10}]
  // end::limit-json[]

offset-json: |
  // tag::offset-json[]
  [{"from": "users",
    "bind": ["username"]},
    {"orderBy": ["username"]},
    {"offset": 10},
    {"limit": 10}]]
  // end::offset-json[]

order-by-json: |
  // tag::order-by-json[]
  [{"from": "orders",
    "bind": ["order-value", "received-at"]},
    {"orderBy": [{"val": {"xt:lvar": "order-value"},
                  "dir": "desc",
                  "nulls": "last"},
                 "received-at"]}]
  // end::order-by-json[]

return-json: |
  // tag::return-json[]
  [{"from": "users",
    "bind": ["username", "first-name", "last-name"]},
    {"return": ["username",
                {"full-name": {"xt:call": "concat",
                               "args": [{"xt:lvar": "last-name"}, ", ", {"xt:lvar": "first-name"}]}}]}]
  // end::return-json[]

rel-json: |
  // tag::rel-json[]
  // as a literal
  {"rel": [{"a": 1, "b": 2},
           {"a": 3, "b": 4}],
   "bind": ["a", "b"]}

  // from a parameter
  {"query" : {"rel": {"xt:param": "$t"},
              "bind": ["a", "b"]}
   "queryOpts": {"args": {"t": [{"a": 1, "b": 2}, {"a": 3, "b": 4}]}}}
  // end::rel-json[]

unify-json: |
  // tag::unify-json[]
  {"unify": [{"from": "customers",
              "bind": [{"xt/id": {"xt:lvar": "customer-id"}}, "customer-name"]},
             {"from": "orders",
              "bind": [{"xt/id": {"xt:lvar": "order-id"}}, "customer-id", "order-value"]}]}
  // end::unify-json[]

unnest-json: |
  // tag::unnest-json[]
  // as a 'tail' operator - N.B. `tag` is a column being added
  [{"from": "posts",
    "bind": [{"xt/id": {"xt:lvar": "post-id"}}, "tags"]},
   {"unnest": {"tag": {"xt:lvar": "tags"}}}]

  // in `unify` - N.B. `tag` is a logic var being introduced
  {"unify": [{"from": "posts",
              "bind": [{"xt/id": {"xt:lvar": "post-id"}}, "tags"]},
             {"unnest": {"tag": {"xt:lvar": "tags"}}}]}
  // end::unnest-json[]

where-json: |
  // tag::where-json[]
  // as a 'tail' operator
  [{"from": "users",
    "bind": ["username", "date-of-birth"]},
   {"where": [{"xt:call": ">",
               "args": [{"xt:call": "current-timestamp"},
                        {"xt:call": "+",
                         "args": [{"xt:lvar": "date-of-birth"},
                                  {"@type": "xt:period",
                                   "@value": "P18Y"}]}]}]}]

  // in `unify`
  {"unify": [{"from": "customers",
              "bind": [{"xt/id": {"xt:lvar": "customer-id"}}, "customer-name", "vip?"]},
             {"from": "orders",
              "bind": [{"xt/id": {"xt:lvar": "order-id"}}, "customer-id", "order-value"]},
             {"where": [{"xt:call": "or",
                         "args": [{"xt:lvar": "vip?"},
                                  {"xt:call": ">",
                                   "args": [{"xt:lvar": "order-value"}, 1000000]}]}]}]}
  // end::where-json[]

with-json: |
  // tag::with-json[]
  // as a 'tail' operator - N.B. `full-name` is a column here
  [{"from": "users",
    "bind": ["username", "first-name", "last-name"]},
    {"with": [{"full-name": {"xt:call": "concat",
                             "args": [{"xt:lvar": "last-name"}, ", ", {"xt:lvar": "first-name"}]}}]}]

  // in 'unify' - N.B. `full-name` is a logic variable here
  {"unify": [{"from": "users",
              "bind": ["username", "first-name", "last-name"]},
             {"with": [{"full-name": {"xt:call": "concat",
                                      "args": [{"xt:lvar": "last-name"}, ", ", {"xt:lvar": "first-name"}]}}]}]}
  // end::with-json[]

without-json: |
  // tag::without-json[]
  [{"unify": [{"from": "customers",
                "bind": [{"xt/id": {"xt:lvar": "customer-id"}}, "customer-name"]},
              {"from": "orders",
               "bind": ["customer-id", "order-value"]}]},
   {"without": ["customer-id"]}]
  // end::without-json[]

expr-json-1: |
  // tag::expr-json-1[]
  [{"from": "posts",
    "bind": [{"xt/id": {"xt:param": "$post-id"}}, "author-id"]},
   {"with": [{"author": {"xt:pull": {"from": "authors",
                                     "bind": [{"xt/id": {"xt:param": "$author-id"}}, "first-name", "last-name"]},
                         "args": ["author-id"]}},
             {"comments": {"xt:pullMany": [{"from": "comments",
                                            "bind": [{"post-id": {"xt:param": "$post-id"}}, "comment", "posted-at"]},
                                           {"orderBy": ["posted-at"]},
                                           {"limit": 2},
                                           {"return": ["comment"]}],
                           "args": [{"post-id": {"xt:param": "$post-id"}}]}}]},
   {"return": ["post-content", "authot", "comments"]}]
  // end::expr-json-1[]

binding-json-1: |
  // tag::binding-json-1[]
  {"from": "users",
   "bind": ["username", "first-name", "last-name"]}
  // i.e. `SELECT username, first_name, last_name FROM users`
  // end::binding-json-1[]

binding-json-2: |
  // tag::binding-json-2[]
  {"from": "users",
   "bind": [{"username": {"xt:lvar": "login"}} , "first-name", "last-name"]}
  // i.e. `SELECT username AS login, first_name, last_name FROM users`
  // end::binding-json-2[]

binding-json-3: |
  // tag::binding-json-3[]
  {"from": "users",
   "bind": [{"username": "james"} , "first-name", "last-name"]}
  // i.e. `SELECT first_name, last_name FROM users WHERE username = 'james'`

  {"from": "users",
   "bind": [{"username": {"xt:param": "$username"}} , "first-name", "last-name"]}
  // i.e. `SELECT first_name, last_name FROM users WHERE username = ?`
  // end::binding-json-3[]

argument-json-1: |
  // tag::argument-json-1[]
  // find the most recent 5 posts and, for each, their most recent 3 comments

  // in this query, the `post-id` argument fulfils the `$post-id` parameter in the sub-query
  [{"from": "posts",
    "bind": [{"xt/id": {"xt:lvar": "post-id"}} ...]},
   {"with": [{"comments":
              {"xt:pullMany": [{"from": "comments",
                                "bind": [{"post-id": {"xt:param": "$post-id"}}, "comment", "commented-at"]},
                               {"limit": 3}],
               "args": ["post-id"]}}]}]
  // end::argument-json-1[]

argument-json-2: |
  // tag::argument-json-2[]
  // find everybody and, for those who have them, their siblings

  // in this query, the `person` argument fulfils the `$person` parameter in the sub-query;
  // `sibling` and `parent` (in `bind`) are joined on the way out.
  [{"unify": [{"from": "people",
               "bind": [{"xt/id": {"xt:lvar": "person"}}, "parent"]},
              {"leftJoin": [{"from": "people",
                             "bind": [{"xt/id": {"xt:lvar": "sibling"}}, "parent"]},
                            {"where": [{"xt:call": "<>",
                                        "args": [{"xt:param": "$person"}, {"xt:lvar": "sibling"}]}]}],
               "args": ["person"],
               "bind": ["sibling", "parent"]}]},
    {"return": ["person", "sibling"]}]
  // tag::argument-json-2[]
